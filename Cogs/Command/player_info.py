# -*- coding: utf-8 -*-

# Ìå®ÌÇ§ÏßÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÑ§Ï†ï
import discord
from discord.ext import commands
from discord.commands import SlashCommandGroup, option
import random
import json
import datetime
import pytz
import traceback

from Extensions.Process.match import get_game_info_by_id
from Extensions.Process.player import get_player_info_by_nickname, get_team_info_by_id, get_player_recent_matches_by_id
from Extensions.Process.search import get_search_player

# config.json ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
try:
    with open(r"./config.json", "rt", encoding="UTF8") as configJson:
        config = json.load(configJson)
except: print("config.jsonÏù¥ Î°úÎìúÎêòÏßÄ ÏïäÏùå")

# league.json ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
try:
    with open(r"./league.json", "rt", encoding="UTF8") as leagueJson:
        leagues = json.load(leagueJson)['leagues']
except: print("league.jsonÏù¥ Î°úÎìúÎêòÏßÄ ÏïäÏùå")

# emoji.json ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
try:
    with open(r"./emoji.json", "rt", encoding="UTF8") as emojiJson:
        emoji = json.load(emojiJson)
except: print("emoji.json ÌååÏùºÏù¥ Î°úÎìúÎêòÏßÄ ÏïäÏùå")

esports_op_gg_player = "https://esports.op.gg/players/"
esports_op_gg_team = "https://esports.op.gg/teams/"
esports_op_gg_match = "https://esports.op.gg/matches/"
op_gg_player = "https://www.op.gg/summoners/"
time_difference = config['time_difference']
colorMap = config['colorMap']
emoji_discord = emoji['Discord']
emoji_esports = emoji['Esports']
emoji_facebook = emoji['Facebook']
emoji_hyperlink = emoji['Hyperlink']
emoji_instagram = emoji['Instagram']
emoji_stream = emoji['LiveStream']
emoji_twitter = emoji['Twitter']
emoji_youtube = emoji['YouTube']


async def search_player(ctx: discord.AutocompleteContext):

    player_displayed_nickname = ""
    try: keyword = ctx.options['Ïù¥Î¶Ñ'].split(" ")[1]
    except: keyword = ctx.options['Ïù¥Î¶Ñ']

    try:
        box_search_data = get_search_player(keyword=keyword)

        for i in range(len(box_search_data)):
            player_displayed_nickname = box_search_data[i]['displayedNickname']

        try:
            print(f"[player_info.py] {box_search_data['code']}: {box_search_data['message']}")
            return [ ]

        except:
            if box_search_data == []: return [ ]
            return [ player_displayed_nickname ]

    except:
        return [ ]


def make_game_info_embed(picked_set, box_player, box_players, box_recent_matches, player_id, player_displayed_nickname, player_nationalty):

    picked_match = box_recent_matches[int(picked_set)]
    match_date = datetime.datetime.strptime(picked_match['beginAt'].split("T")[0], "%Y-%m-%d").strftime("X%YÎÖÑ X%mÏõî X%dÏùº").replace("X0", "").replace("X", "")

    game_info = get_game_info_by_id(match_id=picked_match['id'], match_set=picked_set)
    print(game_info)

    embed = discord.Embed(title=f"'{picked_match['name']} ({picked_set}ÏÑ∏Ìä∏)' Í≤ΩÍ∏∞ Ï†ïÎ≥¥", description=f"{match_date}", color=colorMap['red'])
    embed.set_footer(text="Í∞úÎ∞ú Ï§ëÏù∏ ÎØ∏ÏôÑÏÑ±Îêú Í∏∞Îä•ÏûÖÎãàÎã§.")

    return embed


class MatchInfoSelect(discord.ui.Select):

    def __init__(self, bot, ctx, msg, picked_set, box_player, box_players, box_recent_matches, player_id, player_displayed_nickname, player_nationalty):
        self.bot = bot
        self.ctx = ctx
        self.msg = msg
        self.box_player = box_player
        self.box_players = box_players
        self.box_recent_matches = box_recent_matches
        self.player_id = player_id
        self.player_displayed_nickname = player_displayed_nickname
        self.player_nationalty = player_nationalty

        if picked_set != None: self.picked_set = picked_set
        else: self.picked_set = "1"

        options = []
        for i in range(len(box_recent_matches)):
            options.append(discord.SelectOption(label=f"{box_recent_matches[i]['name']}", value=f"{i}", description=""))

        super().__init__(
            placeholder="ÏûêÏÑ∏Ìûà Î≥º Í≤ΩÍ∏∞ ÏÑ†ÌÉùÌïòÍ∏∞",
            min_values=1,
            max_values=1,
            options=options,
            row=0
        )

    async def callback(self, interaction: discord.Interaction):
        if interaction.user.id != self.ctx.author.id: return await interaction.response.send_message("> ÏûêÏã†Ïùò Î©îÏãúÏßÄÏóêÏÑúÎßå Ïù¥Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî. üò¢", ephemeral=True)

        embed = make_game_info_embed(picked_set=self.picked_set, box_player=self.box_player, box_players=self.box_players, box_recent_matches=self.box_recent_matches, player_id=self.player_id, player_displayed_nickname=self.player_displayed_nickname, player_nationalty=self.player_nationalty)

        await interaction.response.edit_message(content="", embed=embed)


class PlayerInfoView(discord.ui.View):

    def __init__(self, bot, ctx, msg, box_player, box_players, box_recent_matches, player_id, player_displayed_nickname, player_nationalty):
        super().__init__(timeout=60)
        self.bot = bot
        self.ctx = ctx
        self.msg = msg
        self.box_player = box_player
        self.box_players = box_players
        self.box_recent_matches = box_recent_matches
        self.player_id = player_id
        self.player_displayed_nickname = player_displayed_nickname
        self.player_nationalty = player_nationalty

        self.add_item(MatchInfoSelect(bot=self.bot, ctx=self.ctx, msg=self.msg, picked_set=None, box_player=self.box_player, box_players=self.box_players, box_recent_matches=self.box_recent_matches, player_id=self.player_id, player_displayed_nickname=self.player_displayed_nickname, player_nationalty=self.player_nationalty))
        self.add_item(discord.ui.Button(label="OP.GG E-SportsÏóêÏÑú Î≥¥Í∏∞", url=f"{esports_op_gg_player}{player_id}", row=1))
        self.add_item(discord.ui.Button(label="OP.GGÏóêÏÑú Î≥¥Í∏∞", url=f"{op_gg_player}{player_nationalty.lower()}/{player_displayed_nickname}", disabled=True, row=1))

    async def on_timeout(self):
        try:
            await self.msg.edit_original_response(content="", view=DisabledButton(player_id=self.player_id, player_displayed_nickname=self.player_displayed_nickname, player_nationalty=self.player_nationalty))
        except discord.NotFound:
            pass


class DisabledButton(discord.ui.View):

    def __init__(self, player_id, player_displayed_nickname, player_nationalty):
        super().__init__(timeout=None)
        self.add_item(discord.ui.Select(placeholder="ÏûêÏÑ∏Ìûà Î≥º Í≤ΩÍ∏∞ ÏÑ†ÌÉùÌïòÍ∏∞", options=[discord.SelectOption(label="asdf", value="1", description="asdf")], disabled=True, row=0))
        self.add_item(discord.ui.Button(label="OP.GG E-SportsÏóêÏÑú Î≥¥Í∏∞", url=f"{esports_op_gg_player}{player_id}", row=1))
        self.add_item(discord.ui.Button(label="OP.GGÏóêÏÑú Î≥¥Í∏∞", url=f"{op_gg_player}{player_nationalty.lower()}/{player_displayed_nickname}", disabled=True, row=1))


class PlayerInfoCMD(commands.Cog):

    def __init__(self, bot):
        self.bot = bot

    _search = SlashCommandGroup(name="ÏÑ†Ïàò", description="Í≤ÄÏÉâ Î™ÖÎ†πÏñ¥", guild_only=False)

    @_search.command(
        name="Í≤ÄÏÉâ",
        description="Î¶¨Í∑∏ Ïò§Î∏å Î†àÏ†ÑÎìú eÏä§Ìè¨Ï∏†Ïùò ÏÑ†Ïàò Ï†ïÎ≥¥Î•º Í≤ÄÏÉâÌï† Ïàò ÏûàÏñ¥Ïöî.",
    )
    @option("Ïù¥Î¶Ñ", description="Í≤ÄÏÉâÌï† eÏä§Ìè¨Ï∏† ÏÑ†ÏàòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", required=True, autocomplete=search_player)
    async def _playerCMD(self, ctx: discord.AutocompleteContext, Ïù¥Î¶Ñ: str):

        try: picked_player = Ïù¥Î¶Ñ.split(" ")[1]
        except: picked_player = Ïù¥Î¶Ñ
        links = ""
        box_player = []
        box_players = []
        player_id = ""
        player_displayed_nickname = ""
        player_nationalty = ""
        player_league_id = ""
        player_birth_day = ""
        banner_image_url = random.choice(config['banner_image_url'])

        embed = discord.Embed(title="", description="‚åõ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...", color=colorMap['red'])
        msg = await ctx.respond(embed=embed)

        try:
            try:
                box_player = get_player_info_by_nickname(playerNickname=picked_player)

            except:
                embed = discord.Embed(title="> üîç ÏÑ†Ïàò Ï†ïÎ≥¥", description="", color=colorMap['red'])
                embed.set_footer(text="TIP: ÏÑ†ÏàòÎäî ÏòÅÎ¨∏ ÎãâÎÑ§ÏûÑÏúºÎ°úÎßå Í≤ÄÏÉâÌï† Ïàò ÏûàÏñ¥Ïöî.", icon_url=self.bot.user.display_avatar.url)
                embed.set_image(url=banner_image_url)
                embed.add_field(name=f"Í≤ÄÏÉâÏñ¥: '{picked_player}'", value="> ÏÑ†Ïàò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.\n> Í≤ÄÏÉâÏñ¥Í∞Ä Ï†ïÌôïÌïúÏßÄ Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.", inline=False)
                return await msg.edit_original_response(content="", embed=embed)

            try:
                print(f"[player_info.py] {box_player['code']}: {box_player['message']}")
                embed = discord.Embed(title="> ‚ö†Ô∏è Ïò§Î•ò", description=f"Code: `{box_player['code']}`\nMessage: {box_player['message']}", color=colorMap['red'])
                return await msg.edit_original_response(content="", embed=embed)

            except:
                if box_player:
                    for i in range(len(box_player)):
                        player_id = box_player[i]['id']
                        player_displayed_nickname = box_player[i]['nickName']
                        player_nationalty = box_player[i]['team_nationality']

                        for z in range(16):
                            if player_nationalty == leagues[z]['region']:
                                player_league_id = leagues[z]['tournamentId']
                                break

                        box_players = get_team_info_by_id(tournamentId=player_league_id, teamId=box_player[i]['team_id'])
                        box_recentMatches = get_player_recent_matches_by_id(playerId=player_id)

                        try:
                            print(f"[player_info.py] {box_player['code']}: {box_player['message']}")
                            embed = discord.Embed(title="> ‚ö†Ô∏è Ïò§Î•ò", description=f"Code: `{box_player['code']}`\nMessage: {box_player['message']}", color=colorMap['red'])
                            return await msg.edit_original_response(content="", embed=embed)

                        except:
                            if box_players:
                                for j in range(len(box_players)):
                                    if box_player[i]['id'] == box_players[j]['id']:
                                        if box_player[i]['birthday'] == None: player_birth_day = "Ï†ïÎ≥¥ ÏóÜÏùå"
                                        else: player_birth_day = box_player[i]['birthday']

                                        links = f"[{emoji_esports}]({esports_op_gg_player}{box_player[i]['id']}) "
                                        if box_player[i]['stream']: links = f"{links}[{emoji_stream}]({box_player[i]['stream']}) "
                                        if box_player[i]['youtube']: links = f"{links}[{emoji_youtube}]({box_player[i]['youtube']}) "
                                        if box_player[i]['instagram']: links = f"{links}[{emoji_instagram}]({box_player[i]['instagram']}) "
                                        if box_player[i]['facebook']: links = f"{links}[{emoji_facebook}]({box_player[i]['facebook']}) "
                                        if box_player[i]['twitter']: links = f"{links}[{emoji_twitter}]({box_player[i]['twitter']}) "
                                        if box_player[i]['discord']: links = f"{links}[{emoji_discord}]({box_player[i]['discord']}) "
                                        links = links[:-1]

                                        embed = discord.Embed(title=f"> üîç ÏÑ†Ïàò Ï†ïÎ≥¥", description="", color=colorMap['red'])
                                        embed.set_footer(text="TIP: SNS ÏïÑÏù¥ÏΩòÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Ìï¥Îãπ ÏÑ†ÏàòÏùò SNSÎ°ú Î∞îÎ°ú Ïù¥ÎèôÌï† Ïàò ÏûàÏñ¥Ïöî.", icon_url=self.bot.user.display_avatar.url)
                                        # embed.set_image(url=banner_image_url)
                                        embed.set_thumbnail(url=box_player[i]['imageUrl'])
                                        embed.add_field(name="Ïù∏Ï†Å Ï†ïÎ≥¥", value=f"ÎãâÎÑ§ÏûÑ: [{box_player[i]['team_acronym']}]({esports_op_gg_team}{box_player[i]['team_id']}) [{box_player[i]['nickName']}]({esports_op_gg_player}{box_player[i]['id']})\nÎ≥∏Î™Ö: {box_player[i]['firstName']} {box_player[i]['lastName']}\nÌè¨ÏßÄÏÖò: {box_players[j]['position']}", inline=True)
                                        embed.add_field(name="SNS ÌîåÎû´Ìèº", value=links, inline=True)
                                        embed.add_field(name="\u200b", value="", inline=False)
                                        embed.add_field(name="ÏäπÎ•†", value=f"__{box_players[j]['stat_winRate']}__% (__{box_players[j]['stat_wins']:,}__Ïäπ __{box_players[j]['stat_loses']:,}__Ìå®)", inline=False)
                                        embed.add_field(name="KDA Ï†ïÎ≥¥", value=f"{box_players[j]['stat_kda']} ÌèâÏ†ê `({box_players[j]['stat_kills']} / {box_players[j]['stat_deaths']} / {box_players[j]['stat_assists']})`", inline=False)
                                        embed.add_field(name="Í∞ÄÌïú ÌîºÌï¥Îüâ", value=f"Î∂ÑÎãπ {box_players[j]['stat_dpm']:,}Îç∞ÎØ∏ÏßÄ", inline=True)
                                        embed.add_field(name="ÏûÖÏùÄ ÌîºÌï¥Îüâ", value=f"Î∂ÑÎãπ {box_players[j]['stat_dtpm']:,}Îç∞ÎØ∏ÏßÄ", inline=True)
                                        embed.add_field(name="Í≥®Îìú ÌöçÎìù", value=f"Î∂ÑÎãπ {box_players[j]['stat_gpm']:,}Í≥®Îìú", inline=True)
                                        embed.add_field(name="CS", value=f"Î∂ÑÎãπ {box_players[j]['stat_cspm']:,}Í∞ú", inline=True)
                                        embed.add_field(name="Ï≤´ ÌÇ¨Î•†", value=f"{box_players[j]['stat_firstBlood']}%", inline=True)
                                        embed.add_field(name="Ï≤´ ÌÉÄÏõå ÌååÍ¥¥Ïú®", value=f"{box_players[j]['stat_firstTower']}%", inline=True)

                            if box_recentMatches:
                                embed.add_field(name="\u200b", value="", inline=False)

                                msg_recentMatches = ""
                                for k in range(len(box_recentMatches)):
                                    msg_recentMatches += f"[{emoji_hyperlink}]({esports_op_gg_match}{box_recentMatches[k]['id']}) **{box_recentMatches[k]['name']}** (__{box_recentMatches[k]['winner_name']}__ Ïäπ)\n"

                                embed.add_field(name="ÏµúÍ∑º 5Í≤ΩÍ∏∞", value=msg_recentMatches, inline=False)

                    # await msg.edit_original_response(content="", embed=embed, view=DisabledButton(player_id=player_id, player_displayed_nickname=player_displayed_nickname, player_nationalty=player_nationalty))
                    await msg.edit_original_response(content="", embed=embed, view=PlayerInfoView(bot=self.bot, ctx=ctx, msg=msg, box_player=box_player, box_players=box_players, box_recent_matches=box_recentMatches, player_id=player_id, player_displayed_nickname=player_displayed_nickname, player_nationalty=player_nationalty))

        except Exception as error:
            print("\n({})".format(datetime.datetime.now(pytz.timezone("Asia/Seoul")).strftime("%y/%m/%d %H:%M:%S")))
            print(traceback.format_exc())



def setup(bot):
    bot.add_cog(PlayerInfoCMD(bot))
    print("player_info.py Î°úÎìú Îê®")
